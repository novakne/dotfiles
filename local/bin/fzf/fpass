#!/usr/bin/env bash
#
# Search passwords in pass and copy it
#
# USAGE: fpass
#
# REQUIREMENTS: fzf - pass
# OPTIONALS:

shopt -s nullglob globstar

fpass()
{
	local prefix password_files password cmd

	prefix=${PASSWORD_STORE_DIR:-~/.password-store}
	password_files=("${prefix}"/**/*.gpg)
	password_files=("${password_files[@]#"$prefix"/}")
	password_files=("${password_files[@]%.gpg}")

	password=$(printf -- '%s\n' "${password_files[@]}" |
		fzf -0 -1 --prompt='password => ' "$@")

	[[ -n "${password}" ]] || exit

	cmd="pass show -c ${password}"
	setsid /usr/bin/env bash -c "${cmd}" 2>/dev/null
	sleep 0.1
}

fpass "$@"
