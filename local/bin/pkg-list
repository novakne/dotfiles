#!/usr/bin/env bash
#
# List installed packages on Arch Linux


# Help
_usage() {
  cat <<-END
  pkg_dir = $HOME/doc/bkup/pkg

  Usage: pkg-list [OPTION...]

  -a, --all
  List all installed packages and sort by size

  -e, --explicitly
  List all explicitly installed packages
  
  -m --manually
  List all foreign packages
  Manually downloaded/installed || packages removed from the repositories || AUR
  
  -b | --backup
  Backup packages
  To restore: xargs -a /path/to/chosen/directory/pkg-list-backup.list pacman -S --needed 
END
}


main() {

  local pkg_dir file_date

  pkg_dir="$HOME"/doc/bkup/pkg
  file_date=$(date +"%Y_%m_%d")

  # Create pkg_dir if it doesn't exists
  [[ ! -d ${pkg_dir} ]] >/dev/null 2>&1 && mkdir -p "${pkg_dir}"

  case "$1" in
    -a | --all)
      LC_ALL=C pacman -Qi \
        | awk '/^Name/{name=$3} /^Installed Size/{print $4$5, name}' \
        | sort -h >"${pkg_dir}"/"${file_date}"-pkg-list-all.log
      ;;
    -e | --explicitly)
      pacman -Qe >"${pkg_dir}"/"${file_date}"-plkg-list-explicitly.log
      ;;
    -m | --manually)
      pacman -Qm >"${pkg_dir}"/"${file_date}"-pkg-list-manually.log
      ;;
    -u | --aur)
      pacman -Qme >"${pkg_dir}"/"${file_date}"-pkg-list-aur.log
      ;;
    -b | --backup)
      pacman -Qqe | grep -vx "$(pacman -Qqm)" >"${pkg_dir}"/"${file_date}"/pkg-list-backup.list
      pacman -Qqme >"${pkg_dir}"/"${file_date}"/pkg-list-backup-aur.list
      ;;
    *)
      _usage
      exit 1
      ;;
  esac

  unset -v pkg_dir file_date
  unset -f _usage
}

main "$@"

